<script>
    // --- Configuração Inicial ---
    const CONFIG = {
        coroinhas: { linhas: 50, qtdDia: 3 },
        acolitos: { linhas: 25, qtdDia: 2 },
        guardias: { linhas: 20, qtdDia: 4 },
        cerimoniarios: { linhas: 15, qtdDia: 2 },
        irmaos: { linhas: 15 }
    };

    // --- Inicialização ---
    function initSystem() {
        criarInputs('container-coroinhas', CONFIG.coroinhas.linhas, 'coroinha');
        criarInputs('container-acolitos', CONFIG.acolitos.linhas, 'acolito');
        criarInputs('container-guardias', CONFIG.guardias.linhas, 'guardia');
        criarInputs('container-cerimoniarios', CONFIG.cerimoniarios.linhas, 'cerimoniario');
        criarInputsIrmaos('container-irmaos', CONFIG.irmaos.linhas);
    }

    document.addEventListener('DOMContentLoaded', initSystem);

    function criarInputs(containerId, qtd, classe) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = '';
        for(let i=0; i<qtd; i++) {
            const input = document.createElement('input');
            input.type = 'text';
            input.className = `role-input ${classe}`;
            input.placeholder = `Nome ${i+1}`;
            container.appendChild(input);
        }
    }

    function criarInputsIrmaos(containerId, qtd) {
        const container = document.getElementById(containerId);
        if(!container) return;
        container.innerHTML = '';
        for(let i=0; i<qtd; i++) {
            const div = document.createElement('div');
            div.className = 'irmaos-row';
            for(let k=1; k<=4; k++) {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'input-irmao';
                input.placeholder = `Irmão ${k}`;
                div.appendChild(input);
            }
            container.appendChild(div);
        }
    }

    // --- Lógica Principal ---
    function normalizarNome(nome) { return nome ? nome.trim().toUpperCase() : null; }

    function coletarDados() {
        const dados = { coroinhas: [], acolitos: [], guardias: [], cerimoniarios: [], mapaIrmaos: {} };
        const getValues = (classe) => Array.from(document.querySelectorAll(`.${classe}`)).map(i => normalizarNome(i.value)).filter(v => v);

        dados.coroinhas = getValues('coroinha');
        dados.acolitos = getValues('acolito');
        dados.guardias = getValues('guardia');
        dados.cerimoniarios = getValues('cerimoniario');

        document.querySelectorAll('.irmaos-row').forEach(row => {
            const inputs = Array.from(row.querySelectorAll('.input-irmao'));
            const familia = inputs.map(i => normalizarNome(i.value)).filter(v => v);

            if(familia.length > 1) {
                familia.forEach(membroA => {
                    if(!dados.mapaIrmaos[membroA]) dados.mapaIrmaos[membroA] = [];
                    familia.forEach(membroB => {
                        if(membroA !== membroB) {
                            if(!dados.mapaIrmaos[membroA].includes(membroB)) {
                                dados.mapaIrmaos[membroA].push(membroB);
                            }
                        }
                    });
                });
            }
        });

        return dados;
    }

    function shuffle(array) {
        let currentIndex = array.length, randomIndex;
        while (currentIndex != 0) {
            randomIndex = Math.floor(Math.random() * currentIndex);
            currentIndex--;
            [array[currentIndex], array[randomIndex]] = [array[randomIndex], array[currentIndex]];
        }
        return array;
    }

    class GeradorEscala {
        constructor(dados) {
            this.dados = dados;
            this.dias = [];
            this.filas = { coroinhas: [], acolitos: [], guardias: [], cerimoniarios: [] };
        }

        reabastecerFila(tipo) { this.filas[tipo] = shuffle([...this.dados[tipo]]); }

        priorizarIrmao(nomeIrmao, tipoFila) {
            const index = this.filas[tipoFila].indexOf(nomeIrmao);
            if (index > -1) {
                this.filas[tipoFila].splice(index, 1);
                this.filas[tipoFila].unshift(nomeIrmao);
                return true;
            }
            return false;
        }

        // Função auxiliar para descobrir a função de uma pessoa
        getFuncaoPessoa(nome) {
            if (this.dados.coroinhas.includes(nome)) return 'coroinhas';
            if (this.dados.acolitos.includes(nome)) return 'acolitos';
            if (this.dados.guardias.includes(nome)) return 'guardias';
            if (this.dados.cerimoniarios.includes(nome)) return 'cerimoniarios';
            return null;
        }

        // AGORA RECEBE processedRoles e resultadoDia PARA VALIDAR SINCRONIA
        obterPessoas(tipo, quantidade, proibidosNoDia, processedRoles, resultadoDia) {
            let selecionados = [];
            let tentativas = 0;

            while(selecionados.length < quantidade && tentativas < 150) {
                if(this.filas[tipo].length === 0) this.reabastecerFila(tipo);

                let candidato = this.filas[tipo][0];

                // 1. Verificação básica
                if(proibidosNoDia.has(candidato) || selecionados.includes(candidato)) {
                    this.filas[tipo].push(this.filas[tipo].shift());
                    tentativas++;
                    continue;
                }

                // 2. VERIFICAÇÃO DE SEGURANÇA PARA IRMÃOS (NOVA LÓGICA)
                let podeEntrar = true;
                const irmaos = this.dados.mapaIrmaos[candidato];
                
                if (irmaos) {
                    for (let irmao of irmaos) {
                        let roleIrmao = this.getFuncaoPessoa(irmao);
                        // Se o irmão é de outra função E essa função JÁ RODOU hoje
                        if (roleIrmao && roleIrmao !== tipo && processedRoles.has(roleIrmao)) {
                            // Se o irmão NÃO está na lista de hoje daquela função
                            if (!resultadoDia[roleIrmao].includes(irmao)) {
                                podeEntrar = false; // Aborta, tenta amanhã junto com ele
                                break;
                            }
                        }
                    }
                }

                if (!podeEntrar) {
                    // Joga pro final da fila e tenta o próximo
                    this.filas[tipo].push(this.filas[tipo].shift());
                    tentativas++;
                    continue;
                }

                // SE PASSOU EM TUDO, SELECIONA
                this.filas[tipo].shift();
                selecionados.push(candidato);
                proibidosNoDia.add(candidato);

                // PROCESSA OS IRMÃOS (PUXA OU PRIORIZA)
                if(irmaos) {
                    irmaos.forEach(irmao => {
                        // CASO 1: Irmão da MESMA função
                        if (this.filas[tipo].includes(irmao)) {
                            if (selecionados.length < quantidade && !proibidosNoDia.has(irmao)) {
                                let idx = this.filas[tipo].indexOf(irmao);
                                if(idx > -1) {
                                    this.filas[tipo].splice(idx, 1);
                                    selecionados.push(irmao);
                                    proibidosNoDia.add(irmao);
                                }
                            } else {
                                this.priorizarIrmao(irmao, tipo);
                            }
                        }
                        // CASO 2: Irmão de OUTRA função
                        else {
                            ['coroinhas', 'acolitos', 'guardias', 'cerimoniarios'].forEach(filaKey => {
                                if(filaKey !== tipo) {
                                    this.priorizarIrmao(irmao, filaKey);
                                }
                            });
                        }
                    });
                }
            }
            return selecionados;
        }

        gerarMes() {
            for(let key in this.filas) this.reabastecerFila(key);

            for(let dia = 1; dia <= 30; dia++) {
                let proibidosHoje = new Set();
                let resultadoDia = { coroinhas: [], acolitos: [], guardias: [], cerimoniarios: [] };
                let processedRoles = new Set(); // Rastreia quem já foi sorteado hoje

                const ordemSorteio = shuffle(['cerimoniarios', 'guardias', 'acolitos', 'coroinhas']);
                
                ordemSorteio.forEach(categoria => {
                    let qtd = 0;
                    if(categoria === 'cerimoniarios') qtd = CONFIG.cerimoniarios.qtdDia;
                    else if(categoria === 'guardias') qtd = CONFIG.guardias.qtdDia;
                    else if(categoria === 'acolitos') qtd = CONFIG.acolitos.qtdDia;
                    else if(categoria === 'coroinhas') qtd = CONFIG.coroinhas.qtdDia;

                    // Passa processedRoles e resultadoDia para validação cruzada
                    resultadoDia[categoria] = this.obterPessoas(categoria, qtd, proibidosHoje, processedRoles, resultadoDia);
                    
                    // Marca categoria como processada
                    processedRoles.add(categoria);
                });

                // Relatório de Irmãos
                let todosNoDia = Array.from(proibidosHoje);
                let relatoriosFamilia = [];
                let processados = new Set();

                todosNoDia.forEach(p1 => {
                    if(this.dados.mapaIrmaos[p1] && !processados.has(p1)) {
                        let familiaNoDia = [p1];
                        this.dados.mapaIrmaos[p1].forEach(p2 => {
                            if(todosNoDia.includes(p2)) {
                                familiaNoDia.push(p2);
                            }
                        });

                        if(familiaNoDia.length > 1) {
                            familiaNoDia = [...new Set(familiaNoDia)];
                            familiaNoDia.forEach(m => processados.add(m));
                            relatoriosFamilia.push(familiaNoDia.join(', '));
                        }
                    }
                });

                this.dias.push({ dia: dia, escala: resultadoDia, irmaosJuntos: relatoriosFamilia });
            }
        }
    }

    function gerarEscala() {
        const dados = coletarDados();
        if(dados.coroinhas.length === 0 && dados.acolitos.length === 0) {
            alert("Por favor, preencha as tabelas com os nomes antes de gerar.");
            return;
        }
        const gerador = new GeradorEscala(dados);
        gerador.gerarMes();
        renderizar(gerador.dias);
    }

    function renderizar(dias) {
        const container = document.getElementById('resultado');
        container.innerHTML = '';
        dias.forEach(d => {
            const card = document.createElement('div');
            card.className = 'day-card';
            let html = `<div class="day-header">Dia ${d.dia}</div>`;
            const row = (label, nomes) => `<div class="role-group"><span class="role-label">${label}:</span> <span class="role-names">${nomes.join(', ')}</span></div>`;
            html += row('Coroinhas', d.escala.coroinhas);
            html += row('Acólitos', d.escala.acolitos);
            html += row('Guardiãs', d.escala.guardias);
            html += row('Cerimoniários', d.escala.cerimoniarios);

            if(d.irmaosJuntos.length > 0) {
                html += `<div class="sibling-alert">⚠ Famílias no dia: ${d.irmaosJuntos.join(' | ')}</div>`;
            }

            card.innerHTML = html;
            container.appendChild(card);
        });
    }

    function imprimirPDF() {
        if(document.getElementById('resultado').innerHTML.trim() === "") {
            alert("Gere a escala primeiro antes de imprimir!");
            return;
        }
        window.print();
    }
</script>
